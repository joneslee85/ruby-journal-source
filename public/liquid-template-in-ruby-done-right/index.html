
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Liquid template in Ruby done right - Ruby Journal</title>
  <meta name="author" content="Trung LÃª">

  
  <meta name="description" content="Liquid Templating Engine is an awesome technology and with the power of gem &#8216;liquid&#8217;,
everybody can start using without much hassles. I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ruby-journal.com/liquid-template-in-ruby-done-right/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ruby Journal" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Just+Me+Again+Down+Here' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Nixie+One' rel='stylesheet' type='text/css'>
  

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54360362-1', 'auto');
    ga('send', 'pageview');
  </script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruby Journal</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ruby-journal.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Liquid Template in Ruby Done Right</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-10T16:48:00+10:00" pubdate data-updated="true">Apr 10<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content">
<p>Liquid Templating Engine is an awesome technology and with the power of gem &#8216;liquid&#8217;,
everybody can start using without much hassles. I saw many projects used this gem
but sadly most of them are quite bad. In this tutorial, I&#8217;ll go through a bad example
and show you how to refactor it.</p>

<!--more-->

<h2 id="the-smell">The smell</h2>

<p>Below code is for a report generation function for a car dealer Rails app.</p>

<p>Let&#8217;s see the codes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># app/models/car_issue.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">CarIssue</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">belongs_to</span> <span class="ss">:car</span>
</span><span class="line">
</span><span class="line">  <span class="n">liquid_methods</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:reference_number</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># app/models/car.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">has_many</span> <span class="ss">:car_issues</span>
</span><span class="line">  <span class="n">belongs_to</span> <span class="ss">:customer</span>
</span><span class="line">
</span><span class="line">  <span class="n">liquid_methods</span> <span class="ss">:car_make</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:dealer_contact_details</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">owner</span>
</span><span class="line">    <span class="n">customer</span><span class="o">.</span><span class="n">full_name</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">car_make</span>
</span><span class="line">    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">brand</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2"> MY </span><span class="si">#{</span><span class="n">manufacturer_year</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">dealer_contact_details</span>
</span><span class="line"><span class="o">&lt;&lt;-</span><span class="no">CONTACT</span>
</span><span class="line"><span class="sh">  Uber Dealer</span>
</span><span class="line">
</span><span class="line"><span class="sh">  9 Sesame St</span>
</span><span class="line"><span class="sh">  Emo Town</span>
</span><span class="line"><span class="no">CONTACT</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># app/models/customer.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">liquid_methods</span> <span class="ss">:full_name</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">full_name</span>
</span><span class="line">    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># app/services/car_report_generation.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">CarReportGeneration</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">car</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@car</span> <span class="o">=</span> <span class="n">car</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">template</span>
</span><span class="line"><span class="o">&lt;&lt;-</span><span class="no">TEMPLATE</span>
</span><span class="line"><span class="sh">  Dear {{ car.owner }},</span>
</span><span class="line">
</span><span class="line"><span class="sh">  We&#39;ve performed inspection on your {{ car.car_make }} and found following issues:</span>
</span><span class="line">
</span><span class="line"><span class="sh">  {% for issue in car.issues %}</span>
</span><span class="line"><span class="sh">    * {{ issue.reference_number }} - {{ issue.description }}</span>
</span><span class="line"><span class="sh">  {% endfor %}</span>
</span><span class="line">
</span><span class="line"><span class="sh">  Please call us back for quotes</span>
</span><span class="line">
</span><span class="line"><span class="sh">  Sincerely yours</span>
</span><span class="line">
</span><span class="line"><span class="sh">  {{ car.dealer_contact_details }}</span>
</span><span class="line"><span class="no">TEMPLATE</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">generate_report</span>
</span><span class="line">    <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Template</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">render</span> <span class="s1">&#39;car&#39;</span> <span class="o">=&gt;</span> <span class="vi">@car</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As you can see above, the main logic is <code>CarReportGeneration#generate_report</code> which
render the report template using Liquid to populate fields.</p>

<p>What&#8217;s so stink about the above code? In fact, I think it&#8217;s perfectly fine. However should
the report requires more details, user will create more methods within Car model to serve
as report details getter and this could get very ugly quickly as the coupling emerges more
clearly.</p>

<h2 id="refactoring">Refactoring</h2>

<p>We will take many little steps.</p>

<p>The first step is to reduce the coupling between our models and Liquid. As you can see
above that the code exposes methods to Liquid with method <code>liquid_methods</code>. This method
meta-programmingly create for you a class which is a subclass of Liquid::Drop then create
instance methods that matches the parsed method names.</p>

<p>So our Car&#8217;s <code>liquid_methods :car_make, :owner, :dealer_contact_details</code> would do following implicit things:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">Car</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">to_liquid</span>
</span><span class="line">    <span class="ss">Car</span><span class="p">:</span><span class="ss">:LiquidDropClass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Car</span><span class="o">::</span><span class="no">LiquidDropClass</span> <span class="o">&lt;</span> <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Drop</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initalize</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@object</span> <span class="o">=</span> <span class="n">object</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">owner</span>
</span><span class="line">    <span class="vi">@object</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">full_name</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">car_make</span>
</span><span class="line">    <span class="vi">@object</span><span class="o">.</span><span class="n">car_make</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">dealer_contact_details</span>
</span><span class="line">    <span class="vi">@object</span><span class="o">.</span><span class="n">dealer_contact_details</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We see that the magic lies in method <code>to_liquid</code> which point to a <code>Liquid::Drop</code> class.
This special object is what Liquid template takes in to render the template.</p>

<p>Now we could replicate the logic easily. See the code below:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># app/models/car.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">has_many</span> <span class="ss">:car_issues</span>
</span><span class="line">  <span class="n">belongs_to</span> <span class="ss">:customer</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">to_liquid</span>
</span><span class="line">    <span class="no">CarMergeField</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># app/merge_fields/car_merge_field.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">CarMergeField</span> <span class="o">&lt;</span> <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Drop</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:car</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initalize</span><span class="p">(</span><span class="n">car</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@car</span> <span class="o">=</span> <span class="n">car</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">owner</span>
</span><span class="line">    <span class="n">car</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">full_name</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">car_make</span>
</span><span class="line">    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">car</span><span class="o">.</span><span class="n">brand</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">car</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> MY </span><span class="si">#{</span><span class="n">car</span><span class="o">.</span><span class="n">manufacturer_year</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">dealer_contact_details</span>
</span><span class="line"><span class="o">&lt;&lt;-</span><span class="no">CONTACT</span>
</span><span class="line"><span class="sh">  Uber Dealer</span>
</span><span class="line">
</span><span class="line"><span class="sh">  9 Sesame St</span>
</span><span class="line"><span class="sh">  Emo Town</span>
</span><span class="line"><span class="no">CONTACT</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>By moving all Liquid-related methods to a separate class, we leave Car model
clean and slim, well with a cost of one function, that is <code>Car#to_liquid</code>, but
I guess we could live with that for now.</p>

<p>But that&#8217;s the end of refactoring yet, we could see that <code>CarMergeField#dealer_contact_details</code>
should not belong to Car model and would be shared between many reports in the future.</p>

<p>So we create a new class for that:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">DealerMergeField</span> <span class="o">&lt;</span> <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Drop</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">contact_details</span>
</span><span class="line"><span class="o">&lt;&lt;-</span><span class="no">CONTACT</span>
</span><span class="line"><span class="sh">  Uber Dealer</span>
</span><span class="line">
</span><span class="line"><span class="sh">  9 Sesame St</span>
</span><span class="line"><span class="sh">  Emo Town</span>
</span><span class="line"><span class="no">CONTACT</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and make sure we also remove <code>CarMergeField#dealer_contact_details</code> and update our template:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># app/services/car_report_generation.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">CarReportGeneration</span> <span class="k">do</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">template</span>
</span><span class="line"><span class="o">&lt;&lt;-</span><span class="no">TEMPLATE</span>
</span><span class="line"><span class="sh">  Dear {{ car.owner }},</span>
</span><span class="line">
</span><span class="line"><span class="sh">  We&#39;ve performed inspection on your {{ car.car_make }} and found following issues:</span>
</span><span class="line">
</span><span class="line"><span class="sh">  {% for issue in car.issues %}</span>
</span><span class="line"><span class="sh">    * {{ issue.reference_number }} - {{ issue.description }}</span>
</span><span class="line"><span class="sh">  {% endfor %}</span>
</span><span class="line">
</span><span class="line"><span class="sh">  Please call us back for quotes</span>
</span><span class="line">
</span><span class="line"><span class="sh">  Sincerely yours</span>
</span><span class="line">
</span><span class="line"><span class="sh">  {{ dealer.contact_details }}</span>
</span><span class="line"><span class="no">TEMPLATE</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">generate_report</span>
</span><span class="line">    <span class="n">liquid_drops</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">      <span class="s1">&#39;car&#39;</span> <span class="o">=&gt;</span> <span class="vi">@car</span><span class="p">,</span>
</span><span class="line">      <span class="s1">&#39;dealer&#39;</span> <span class="o">=&gt;</span> <span class="no">DealerMergeField</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Template</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">liquid_drops</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Please pay attention closely to the <code>CarReportGeneration#generate_report</code>, you could
see that I parse in new liquid drop <code>dealer</code> which is an object of <code>DealerMergeField</code>.
FYI, the liquid does not have to tie to a model. We now could carry on and apply
the same technique for model CarIssue.</p>

<p>Yet, I am not satisfied, we could push abit further by extraction common liquid
rendering logic into its own class and encourage reusability of this class for
other reports.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># app/services/report_generation.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">ReportGeneration</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:report</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@report</span> <span class="o">=</span> <span class="n">report</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">generate_report</span>
</span><span class="line">    <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Template</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">liquid_drops</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># app/reports/car_report.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">CarReport</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">car</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@car</span> <span class="o">=</span> <span class="n">car</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">template</span>
</span><span class="line"><span class="o">&lt;&lt;-</span><span class="no">TEMPLATE</span>
</span><span class="line"><span class="sh">  Dear {{ car.owner }},</span>
</span><span class="line">
</span><span class="line"><span class="sh">  We&#39;ve performed inspection on your {{ car.car_make }} and found following issues:</span>
</span><span class="line">
</span><span class="line"><span class="sh">  {% for issue in car.issues %}</span>
</span><span class="line"><span class="sh">    * {{ issue.reference_number }} - {{ issue.description }}</span>
</span><span class="line"><span class="sh">  {% endfor %}</span>
</span><span class="line">
</span><span class="line"><span class="sh">  Please call us back for quotes</span>
</span><span class="line">
</span><span class="line"><span class="sh">  Sincerely yours</span>
</span><span class="line">
</span><span class="line"><span class="sh">  {{ dealer.contact_details }}</span>
</span><span class="line"><span class="no">TEMPLATE</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">liquid_drops</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">      <span class="s1">&#39;car&#39;</span> <span class="o">=&gt;</span> <span class="vi">@car</span><span class="p">,</span>
</span><span class="line">      <span class="s1">&#39;dealer&#39;</span> <span class="o">=&gt;</span> <span class="no">DealerMergeField</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and to use it we do:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">car_report</span> <span class="o">=</span> <span class="no">CarReport</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@car</span><span class="p">)</span>
</span><span class="line"><span class="no">ReportGeneration</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">car_report</span><span class="p">)</span><span class="o">.</span><span class="n">generate_report</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="conclusion">Conclusion</h2>

<p>Never let a gem manipulate you. If you see a gem makes you do bad things,
then you should dig deeper. Even writing new thing your own is not a bad
solution. If you don&#8217;t have time for that, make sure you write abstract
method that could help you untangle the coupling later.</p>

<p>I hope this is useful to some. I really welcome feedbacks.</p>

<p>Keep on learning folks!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Trung LÃª</span></span>

      








  


<time datetime="2014-04-10T16:48:00+10:00" pubdate data-updated="true">Apr 10<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://ruby-journal.com/liquid-template-in-ruby-done-right/" data-via="joneslee85" data-counturl="http://ruby-journal.com/liquid-template-in-ruby-done-right/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/how-to-style-kaminari-pagination-with-twitter-bootstrap-3/" title="Previous Post: How to style kaminari pagination with Twitter Bootstrap 3">&laquo; How to style kaminari pagination with Twitter Bootstrap 3</a>
      
      
        <a class="basic-alignment right" href="/how-to-dry-your-rails-routes/" title="Next Post: How to DRY your Rails routes">How to DRY your Rails routes &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Humble Ruby developer</p>
  <p>Core dev at <a href="http://spreecommerce.com">Spree Commerce</a> and <a href="http://lotusrb.org">Lotus Framework</a></p>
  <p>I love art, reading history book, table tennis, golf and my beloved <a href="http://ruby.org.vn">Ruby Vietnam</a></p>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/lotusrb/how-to-add-basic-authentication-into-lotus-app/">How to add basic authentication into Lotus app</a>
      </li>
    
      <li class="post">
        <a href="/rails/the-difference-between-activerecord-scope-dsl-and-class-method/">The difference between ActiveRecord scope DSL and class method</a>
      </li>
    
      <li class="post">
        <a href="/how-to-add-new-column-after-existing-column-with-mysql-in-rails/">How to add new column after existing column with MySQL in Rails?</a>
      </li>
    
      <li class="post">
        <a href="/how-to-open-slash-override-slash-monkey-patch-a-class-in-ruby/">How to open/override/monkey-patch a class in Ruby?</a>
      </li>
    
      <li class="post">
        <a href="/quick-guide-to-activesupport-hashwithindifferentaccess/">Quick guide to ActiveSupport::HashWithIndifferentAccess</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/joneslee85">@joneslee85</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joneslee85',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("joneslee85", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/joneslee85" class="twitter-follow-button" data-show-count="false">Follow @joneslee85</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/joneslee85?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Trung LÃª -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ruby-journal';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ruby-journal.com/liquid-template-in-ruby-done-right/';
        var disqus_url = 'http://ruby-journal.com/liquid-template-in-ruby-done-right/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
